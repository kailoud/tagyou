<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Test</title>
  <link rel="stylesheet" href="auth-styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }

    .test-container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
      font-size: 16px;
    }

    .test-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
  </style>
</head>

<body>
  <div class="test-container">
    <h1>üîê Authentication Test</h1>
    <p>This page tests the authentication system to ensure it's working correctly.</p>

    <div id="status"></div>

    <h2>Test Actions:</h2>
    <button class="test-button" onclick="testSupabaseConnection()">
      üîó Test Supabase Connection
    </button>
    <button class="test-button" onclick="testAuthService()">
      üîê Test Auth Service
    </button>
    <button class="test-button" onclick="showSignInModal()">
      üìù Show Sign In Modal
    </button>
    <button class="test-button" onclick="showSignUpModal()">
      ‚ú® Show Sign Up Modal
    </button>
    <button class="test-button" onclick="testSignUp()">
      üß™ Test Sign Up
    </button>
    <button class="test-button" onclick="testSignIn()">
      üß™ Test Sign In
    </button>

    <h2>Current Status:</h2>
    <div id="currentStatus">Loading...</div>
  </div>

  <script type="module">
    let authService = null;
    let supabase = null;

    // Initialize Supabase
    async function initializeSupabase() {
      try {
        console.log('üîê Initializing Supabase...');

        // Import Supabase config
        const supabaseConfig = await import('./supabase-config-secret.js');

        // Create Supabase client
        supabase = window.supabase.createClient(
          supabaseConfig.default.supabaseUrl,
          supabaseConfig.default.supabaseAnonKey
        );

        // Make globally accessible
        window.supabase = supabase;

        console.log('‚úÖ Supabase initialized');
        updateStatus('Supabase initialized successfully', 'success');
        return true;
      } catch (error) {
        console.error('‚ùå Supabase initialization failed:', error);
        updateStatus('Supabase initialization failed: ' + error.message, 'error');
        return false;
      }
    }

    // Initialize Auth Service
    async function initializeAuthService() {
      try {
        console.log('üîê Initializing Auth Service...');

        // Import auth service
        const { supabaseAuthService, setSupabaseInstance } = await import('./supabase-auth-service.js');

        // Set Supabase instance
        setSupabaseInstance(supabase);

        // Initialize auth service
        authService = supabaseAuthService;
        const success = await authService.initialize();

        if (success) {
          console.log('‚úÖ Auth service initialized');
          updateStatus('Auth service initialized successfully', 'success');

          // Set up auth state listener
          authService.onAuthStateChanged((user) => {
            console.log('üîê Auth state changed:', user ? user.email : 'No user');
            updateCurrentStatus();
          });

          return true;
        } else {
          throw new Error('Auth service initialization failed');
        }
      } catch (error) {
        console.error('‚ùå Auth service initialization failed:', error);
        updateStatus('Auth service initialization failed: ' + error.message, 'error');
        return false;
      }
    }

    // Update status display
    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Update current status
    function updateCurrentStatus() {
      const statusDiv = document.getElementById('currentStatus');
      if (authService) {
        const user = authService.getCurrentUser();
        if (user) {
          statusDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ Signed in as: ${user.email}
                        </div>
                    `;
        } else {
          statusDiv.innerHTML = `
                        <div class="status info">
                            üë§ Not signed in
                        </div>
                    `;
        }
      } else {
        statusDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå Auth service not available
                    </div>
                `;
      }
    }

    // Test functions
    window.testSupabaseConnection = async function () {
      try {
        const { data, error } = await supabase.from('profiles').select('count').limit(1);
        if (error) {
          updateStatus('Supabase connection failed: ' + error.message, 'error');
        } else {
          updateStatus('Supabase connection successful!', 'success');
        }
      } catch (error) {
        updateStatus('Supabase test failed: ' + error.message, 'error');
      }
    };

    window.testAuthService = function () {
      if (authService) {
        updateStatus('Auth service is available and working', 'success');
      } else {
        updateStatus('Auth service is not available', 'error');
      }
    };

    window.showSignInModal = function () {
      if (authService && authService.showSignInModal) {
        authService.showSignInModal();
        updateStatus('Sign in modal should be visible', 'info');
      } else {
        updateStatus('Auth service or showSignInModal not available', 'error');
      }
    };

    window.showSignUpModal = function () {
      if (authService && authService.showSignUpModal) {
        authService.showSignUpModal();
        updateStatus('Sign up modal should be visible', 'info');
      } else {
        updateStatus('Auth service or showSignUpModal not available', 'error');
      }
    };

    window.testSignUp = async function () {
      if (!authService) {
        updateStatus('Auth service not available', 'error');
        return;
      }

      try {
        const result = await authService.signUp('test@example.com', 'testpassword123');
        updateStatus('Sign up test successful: ' + JSON.stringify(result), 'success');
      } catch (error) {
        updateStatus('Sign up test failed: ' + error.message, 'error');
      }
    };

    window.testSignIn = async function () {
      if (!authService) {
        updateStatus('Auth service not available', 'error');
        return;
      }

      try {
        const result = await authService.signIn('test@example.com', 'testpassword123');
        updateStatus('Sign in test successful: ' + JSON.stringify(result), 'success');
      } catch (error) {
        updateStatus('Sign in test failed: ' + error.message, 'error');
      }
    };

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', async function () {
      console.log('üöÄ Starting authentication test...');

      // Initialize Supabase first
      const supabaseSuccess = await initializeSupabase();
      if (supabaseSuccess) {
        // Initialize auth service
        await initializeAuthService();
      }

      // Update current status
      updateCurrentStatus();
    });
  </script>
</body>

</html>